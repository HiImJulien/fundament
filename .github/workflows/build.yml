name: Build

on:
    push:
        branches:   [ master, development ]

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
          matrix:
              os: [ubuntu-latest, macOS-latest, windows-latest]
        steps:
        - uses: actions/checkout@v2
          with:
            fetch-depth: 0
        - uses: actions/setup-python@v2
          with:
            python-version: 3.7
        - name: Install tools
          if: ${{ matrix.os == 'ubuntu-latest' }}
          run: | 
            sudo apt-get update
            sudo apt-get install libx11-xcb-dev -y
            sudo apt-get install libxcb*-dev -y
            sudo apt-get install pkg-config -y
        - uses: actions/cache@v2
          id: build_cache
          env:
            cache-name: cache-build
          with:
            path: 
              ./build
            key: ${{ matrix.os }}-build-${{ hashFiles('wscript', 'lib', 'tools') }}
            restore-keys: |
                ${{ matrix.os }}-build-
        - name: Build
          if: steps.build_cache.outputs.cache-hit != 'true'
          run: |
            python waf configure
            python waf package
        - name: Push package
          if: ${{ matrix.os == 'windows-latest' && (steps.build_cache.outputs.cache-hit != 'true') }} 
          run: |
            nuget setApiKey ${{ secrets.NUGET_API_KEY }} -Source nuget.org
            nuget push **/kirsch.*.nupkg -Source nuget.org -SkipDuplicate 
            nuget sources Add -Name GitHub -Source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json -Username ${{ github.repository_owner }} -Password ${{ secrets.GITHUB_TOKEN }}
            nuget push **/kirsch.*.nupkg -Source GitHub -SkipDuplicate
